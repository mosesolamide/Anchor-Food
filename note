// riders-dashboard.ts

// Display available orders
const displayAvailableOrders = async () => {
  const { data: orders, error } = await supabase
    .from('orders')
    .select('*')
    .eq('status', 'pending')
    .eq('payment_status', 'paid')
    .order('created_at', { ascending: false })

  if (error || !orders) {
    console.error('Error fetching orders:', error)
    return
  }

  const ordersContainer = document.getElementById('orders-container')
  if (!ordersContainer) return

  if (orders.length === 0) {
    ordersContainer.innerHTML = `
      <div class="text-center py-12">
        <p class="text-gray-500 text-lg">No orders available right now</p>
        <p class="text-sm text-gray-400 mt-2">Check back in a few minutes</p>
      </div>
    `
    return
  }

  ordersContainer.innerHTML = orders.map(order => `
    <div class="bg-white border-2 border-gray-200 rounded-xl p-6 mb-4 hover:border-green-500 transition shadow-md">
      <div class="flex justify-between items-start mb-4">
        <div>
          <h3 class="font-bold text-xl text-gray-800">New Order!</h3>
          <p class="text-sm text-gray-600 mt-1">üìç ${order.delivery_location}</p>
          <p class="text-sm text-gray-600">üìß ${order.customer_email}</p>
          <p class="text-sm text-gray-600">üì± ${order.customer_phone}</p>
        </div>
        <div class="text-right">
          <p class="text-sm text-gray-500">You'll receive:</p>
          <p class="text-3xl font-bold text-green-600">‚Ç¶${(order.food_cost + order.delivery_fee).toLocaleString()}</p>
        </div>
      </div>

      <div class="bg-green-50 rounded-lg p-4 mb-4 space-y-2">
        <div class="flex justify-between text-sm">
          <span class="text-gray-600">Food Cost:</span>
          <span class="font-semibold text-gray-800">‚Ç¶${order.food_cost.toLocaleString()}</span>
        </div>
        <div class="flex justify-between text-sm">
          <span class="text-gray-600">Your Delivery Fee:</span>
          <span class="font-semibold text-green-600">‚Ç¶${order.delivery_fee.toLocaleString()}</span>
        </div>
        <div class="border-t border-green-200 pt-2 flex justify-between">
          <span class="font-bold text-gray-800">Total to Your Account:</span>
          <span class="font-bold text-green-600 text-lg">‚Ç¶${(order.food_cost + order.delivery_fee).toLocaleString()}</span>
        </div>
      </div>

      <div class="bg-yellow-50 border-l-4 border-yellow-400 p-3 mb-4 rounded">
        <p class="text-xs text-gray-700">
          <strong>üí° How it works:</strong> Accept this order and ‚Ç¶${(order.food_cost + order.delivery_fee).toLocaleString()} will be sent to your bank account immediately. Use ‚Ç¶${order.food_cost.toLocaleString()} to buy the food and keep ‚Ç¶${order.delivery_fee.toLocaleString()} as your delivery fee.
        </p>
      </div>

      <button 
        onclick="acceptOrder('${order.id}', '${localStorage.getItem('rider_id')}')"
        class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-lg transition shadow-lg hover:shadow-xl active:scale-95"
      >
        Accept & Get Paid ‚Ç¶${(order.food_cost + order.delivery_fee).toLocaleString()} Now!
      </button>
    </div>
  `).join('')
}

// Real-time updates (listen for new orders)
const subscribeToNewOrders = () => {
  const channel = supabase
    .channel('orders-channel')
    .on(
      'postgres_changes',
      {
        event: 'INSERT',
        schema: 'public',
        table: 'orders',
        filter: 'status=eq.pending'
      },
      (payload) => {
        console.log('üîî New order!', payload.new)
        displayAvailableOrders() // Refresh list
        
        // Optional: Play notification sound
        new Audio('/notification.mp3').play()
      }
    )
    .subscribe()

  return channel
}

// Initialize
window.onload = () => {
  displayAvailableOrders()
  subscribeToNewOrders()
}
```

---

## **Money Flow Summary:**
```
1. Customer pays ‚Ç¶10,000
        ‚Üì
   Goes to YOUR Paystack account
   
2. Rider accepts order
        ‚Üì
   Your system AUTOMATICALLY transfers ‚Ç¶9,500 to rider
   (‚Ç¶8,500 for food + ‚Ç¶1,000 delivery fee)
        ‚Üì
   Rider receives money in their bank
   
3. You keep ‚Ç¶500 (your platform fee)
        ‚Üì
   Rider buys food with ‚Ç¶8,500
   Rider delivers to customer
   Rider keeps ‚Ç¶1,000
```

---

## **Complete Flow Visualization:**
```
Customer Orders ‚Ç¶10,000 food
         ‚Üì
    Pays via Paystack
         ‚Üì
    ‚Ç¶10,000 ‚Üí YOUR Account
         ‚Üì
  Order appears on riders' dashboard
         ‚Üì
    Rider clicks "Accept"
         ‚Üì
  ü§ñ AUTOMATIC TRANSFER:
  ‚Ç¶9,500 ‚Üí Rider's Bank Account
         ‚Üì
    Rider gets notification
    "‚Ç¶9,500 credited to your account!"
         ‚Üì
    Rider uses ‚Ç¶8,500 to buy food
    Rider delivers to customer
    Rider keeps ‚Ç¶1,000 as profit
         ‚Üì
    You keep ‚Ç¶500 in YOUR account ‚úÖ